package hn.com.tigo.equipmentblacklist.services;

import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import hn.com.tigo.equipmentblacklist.entities.ArchiveStolenDefectivePhoneEntity;
import hn.com.tigo.equipmentblacklist.entities.BanditDetailEntity;
import hn.com.tigo.equipmentblacklist.exceptions.BadRequestException;
import hn.com.tigo.equipmentblacklist.models.AddBloqueoImeiRequestModel;
import hn.com.tigo.equipmentblacklist.models.ArchiveStolenDefectivePhoneModel;
import hn.com.tigo.equipmentblacklist.models.GeneralResponseImeiModel;
import hn.com.tigo.equipmentblacklist.models.RemoveBloqueoImeiRequestModel;
import hn.com.tigo.equipmentblacklist.repositories.BanditDetailRepository;
import hn.com.tigo.equipmentblacklist.repositories.IArchiveStolenDefectivePhoneRepository;
import hn.com.tigo.equipmentblacklist.services.interfaces.IArchiveStolenDefectivePhoneService;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class ArchiveStolenDefectivePhoneServiceImpl implements IArchiveStolenDefectivePhoneService {

	private final IArchiveStolenDefectivePhoneRepository archiveStolenPhoneRepository;
	private final BanditDetailRepository banditDetailRepository;

	public ArchiveStolenDefectivePhoneServiceImpl(IArchiveStolenDefectivePhoneRepository archiveStolenPhoneRepository,
			BanditDetailRepository banditDetailRepository) {
		this.archiveStolenPhoneRepository = archiveStolenPhoneRepository;
		this.banditDetailRepository = banditDetailRepository;
	}

	@Override
	public List<ArchiveStolenDefectivePhoneModel> getAll() {
		List<ArchiveStolenDefectivePhoneEntity> entities = this.archiveStolenPhoneRepository.findAll();
		return entities.stream().map(ArchiveStolenDefectivePhoneEntity::entityToModel).collect(Collectors.toList());
	}

	@Override
	public ArchiveStolenDefectivePhoneModel getById(Long id) {
		ArchiveStolenDefectivePhoneEntity entity = this.archiveStolenPhoneRepository.findById(id).orElse(null);
		if (entity == null)
			throw new BadRequestException(String.format("Error get, Record with id %s is not valid", id));
		return entity.entityToModel();
	}

	@Override
	public List<ArchiveStolenDefectivePhoneModel> findByWithType(int type, String value) {
		List<ArchiveStolenDefectivePhoneEntity> entities;
		entities = this.archiveStolenPhoneRepository.findByType(type, value);
		return entities.stream().map(ArchiveStolenDefectivePhoneEntity::entityToModel).collect(Collectors.toList());
	}

	@Override
	public void add(ArchiveStolenDefectivePhoneModel model) {
		ArchiveStolenDefectivePhoneEntity entity = new ArchiveStolenDefectivePhoneEntity();
		entity.setId(-1L);
		entity.setEsn(model.getEsn());
		entity.setAcctCode(model.getAcctCode());
		entity.setSubscriberId(model.getSubscriberId());
		entity.setBlockType(model.getBlockType());
		entity.setCreatedDate(model.getCreatedDate());
		this.archiveStolenPhoneRepository.save(entity);
	}

	@Override
	public void update(Long id, ArchiveStolenDefectivePhoneModel model) {
		ArchiveStolenDefectivePhoneEntity entity = this.archiveStolenPhoneRepository.findById(id).orElse(null);
		if (entity == null)
			throw new BadRequestException(String.format("Error update, Record with id %s is not valid", id));
		entity.setEsn(model.getEsn());
		entity.setAcctCode(model.getAcctCode());
		entity.setSubscriberId(model.getSubscriberId());
		entity.setBlockType(model.getBlockType());
		entity.setCreatedDate(model.getCreatedDate());
		this.archiveStolenPhoneRepository.save(entity);
	}

	@Override
	public void delete(Long id) {
		ArchiveStolenDefectivePhoneEntity entity = this.archiveStolenPhoneRepository.findById(id).orElse(null);
		if (entity == null)
			throw new BadRequestException(String.format("Record with id %s is not valid", id));
		this.archiveStolenPhoneRepository.delete(entity);
	}

	@Override
	@Transactional
	public GeneralResponseImeiModel addBloqueoImei(AddBloqueoImeiRequestModel request) {
		try {
			// Validación de estructura del request
			if (request == null || request.getDetallebandit() == null) {
				GeneralResponseImeiModel.GeneralResponse errorResponse = new GeneralResponseImeiModel.GeneralResponse(
						400, "Bad Request", "ERROR", "ERROR");
				GeneralResponseImeiModel.ReturnData returnData = new GeneralResponseImeiModel.ReturnData(errorResponse);
				return new GeneralResponseImeiModel(returnData);
			}

			// Validación de campos en el request
			if (request.getDetallebandit().getEsnImei() == null || request.getDetallebandit().getEsnImei().isEmpty()) {
				GeneralResponseImeiModel.GeneralResponse errorResponse = new GeneralResponseImeiModel.GeneralResponse(
						400, "EsnImei is required", "ERROR", "ERROR");
				GeneralResponseImeiModel.ReturnData returnData = new GeneralResponseImeiModel.ReturnData(errorResponse);
				return new GeneralResponseImeiModel(returnData);
			}

			if (archiveStolenPhoneRepository.existsByEsnAndStatus(request.getDetallebandit().getEsnImei(), 1L)) {
				return new GeneralResponseImeiModel(
						new GeneralResponseImeiModel.ReturnData(new GeneralResponseImeiModel.GeneralResponse(400,
								"La línea ya está bloqueada", "ERROR", "ERROR")));
			}

			ArchiveStolenDefectivePhoneEntity entity = new ArchiveStolenDefectivePhoneEntity();
			entity.setId(-1L);
			entity.setEsn(request.getDetallebandit().getEsnImei());
			entity.setAcctCode(request.getDetallebandit().getAnexo());
			entity.setSubscriberId(request.getDetallebandit().getTelefono());
			entity.setBlockType(request.getTipobloqueo());
			entity.setStatus(1L);
			entity.setCreatedDate(LocalDateTime.now());
			archiveStolenPhoneRepository.save(entity);

			BanditDetailEntity banditDetailEntity = new BanditDetailEntity();
			banditDetailEntity.setId(-1L);
			banditDetailEntity.setAnnex(request.getDetallebandit().getAnexo());
			banditDetailEntity.setYearTransaction(request.getDetallebandit().getAnoTransaccion());
			banditDetailEntity.setDayTransaction(request.getDetallebandit().getDiaTransaccion());
			banditDetailEntity.setTransactionUserAddress(request.getDetallebandit().getDireccionUsuarioTransaccion());
			banditDetailEntity.setEsnImei(request.getDetallebandit().getEsnImei());
			banditDetailEntity.setStatusLowHigh(request.getDetallebandit().getEstadoBajaAlta());
			banditDetailEntity.setTransactionTime(request.getDetallebandit().getHoraTransaccion());
			banditDetailEntity.setTransactionUserIdentity(request.getDetallebandit().getIdentidadUsuarioTransaccion());
			banditDetailEntity.setIvesn(request.getDetallebandit().getIvesn());
			banditDetailEntity.setMonthTransaction(request.getDetallebandit().getMesTransaccion());
			banditDetailEntity.setTransactionReason(request.getDetallebandit().getMotivoTransaccion());
			banditDetailEntity.setTransactionUserName(request.getDetallebandit().getNombreUsuarioTransaccion());
			banditDetailEntity.setOperator(request.getDetallebandit().getOperador());
			banditDetailEntity.setTransactionScreen(request.getDetallebandit().getPantallaTransaccion());
			banditDetailEntity.setSimcard(request.getDetallebandit().getSimcard());
			banditDetailEntity.setTechnologyType(request.getDetallebandit().getTechnologyType());
			banditDetailEntity.setPhone(request.getDetallebandit().getTelefono());
			banditDetailEntity.setTransactionUserPhone(request.getDetallebandit().getTelefonoUsuarioTransaccion());
			banditDetailEntity.setTransactionUser(request.getDetallebandit().getUsuarioTransaccion());

			banditDetailRepository.save(banditDetailEntity);

			// Respuesta exitosa
			GeneralResponseImeiModel.GeneralResponse generalResponse = new GeneralResponseImeiModel.GeneralResponse(1,
					"Service Completed", "OK", "INFO");
			GeneralResponseImeiModel.ReturnData returnData = new GeneralResponseImeiModel.ReturnData(generalResponse);
			return new GeneralResponseImeiModel(returnData);

		} catch (DataIntegrityViolationException e) {
			// Validación de errores de base de datos
			GeneralResponseImeiModel.GeneralResponse errorResponse = new GeneralResponseImeiModel.GeneralResponse(602,
					"Data Integrity Violation", "ERROR", "ERROR");
			GeneralResponseImeiModel.ReturnData returnData = new GeneralResponseImeiModel.ReturnData(errorResponse);
			return new GeneralResponseImeiModel(returnData);
		} catch (Exception e) {
			e.printStackTrace();

			// Respuesta de error por defecto
			GeneralResponseImeiModel.GeneralResponse generalResponse = new GeneralResponseImeiModel.GeneralResponse(601,
					"Internal Server Error", "ERROR", "ERROR");
			GeneralResponseImeiModel.ReturnData returnData = new GeneralResponseImeiModel.ReturnData(generalResponse);
			return new GeneralResponseImeiModel(returnData);
		}
	}

	@Override
	public GeneralResponseImeiModel removeBloqueoImei(RemoveBloqueoImeiRequestModel request) {
		// TODO Auto-generated method stub
		return null;
	}

}
