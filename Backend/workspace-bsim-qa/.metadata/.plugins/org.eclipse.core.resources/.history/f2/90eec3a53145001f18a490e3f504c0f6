package hn.com.tigo.equipmentaccessoriesbilling.services;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import javax.validation.Valid;
import javax.ws.rs.BadRequestException;

import java.util.Map;

import org.apache.commons.lang3.StringUtils;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;

import hn.com.tigo.equipmentaccessoriesbilling.entities.BillingEntity;
import hn.com.tigo.equipmentaccessoriesbilling.entities.BillingServicesEntity;
import hn.com.tigo.equipmentaccessoriesbilling.entities.BranchOfficesEntity;
import hn.com.tigo.equipmentaccessoriesbilling.entities.ChannelEntity;
import hn.com.tigo.equipmentaccessoriesbilling.entities.ControlUserPermissionsEntity;
import hn.com.tigo.equipmentaccessoriesbilling.entities.InvoiceDetailEntity;
import hn.com.tigo.equipmentaccessoriesbilling.entities.TypeUserEntity;
import hn.com.tigo.equipmentaccessoriesbilling.entities.UserBranchOfficesEntity;
import hn.com.tigo.equipmentaccessoriesbilling.entities.UsersEntity;
import hn.com.tigo.equipmentaccessoriesbilling.models.AuthenticationBsimResponse;
import hn.com.tigo.equipmentaccessoriesbilling.models.BillingModel;
import hn.com.tigo.equipmentaccessoriesbilling.models.BranchOfficeAndStatus;
import hn.com.tigo.equipmentaccessoriesbilling.models.BranchOfficesModel;
import hn.com.tigo.equipmentaccessoriesbilling.models.ConfigParametersModel;
import hn.com.tigo.equipmentaccessoriesbilling.models.InvoiceDetailGraphicsResponse;
import hn.com.tigo.equipmentaccessoriesbilling.models.InvoiceTypeAndStatus;
import hn.com.tigo.equipmentaccessoriesbilling.repositories.IBillingRepository;
import hn.com.tigo.equipmentaccessoriesbilling.repositories.IBillingServicesRepository;
import hn.com.tigo.equipmentaccessoriesbilling.repositories.IBranchOfficesRepository;
import hn.com.tigo.equipmentaccessoriesbilling.repositories.IChannelRepository;
import hn.com.tigo.equipmentaccessoriesbilling.repositories.IControlUserPermissionsRepository;
import hn.com.tigo.equipmentaccessoriesbilling.repositories.IInvoiceDetailRepository;
import hn.com.tigo.equipmentaccessoriesbilling.repositories.ITypeUserRepository;
import hn.com.tigo.equipmentaccessoriesbilling.repositories.IUserBranchOfficesRepository;
import hn.com.tigo.equipmentaccessoriesbilling.services.interfaces.IBillingService;
import hn.com.tigo.equipmentaccessoriesbilling.services.interfaces.IBranchOfficesService;
import hn.com.tigo.equipmentaccessoriesbilling.services.interfaces.IConfigParametersService;
import hn.com.tigo.equipmentaccessoriesbilling.services.interfaces.ILogsService;
import hn.com.tigo.equipmentaccessoriesbilling.services.interfaces.IUserBranchOfficesService;
import hn.com.tigo.equipmentaccessoriesbilling.services.interfaces.IUsersService;
import hn.com.tigo.equipmentaccessoriesbilling.utils.Constants;
import hn.com.tigo.equipmentaccessoriesbilling.utils.InvoiceGraphFiltersSpecifications;
import hn.com.tigo.equipmentaccessoriesbilling.utils.InvoicePrintingDetailGenerator;
import hn.com.tigo.equipmentaccessoriesbilling.utils.InvoiceSpecifications;

@Service
public class BillingServiceImpl implements IBillingService {

	private final IBillingRepository billingRepository;
	private final ILogsService logsService;
	private final IInvoiceDetailRepository invoiceDetailRepository;
	private final IBillingServicesRepository billingServicesRepository;
	private final IUserBranchOfficesService userBranchOfficesService;
	private final IUsersService usersService;
	private final IBranchOfficesService branchOfficesService;
	private final IBranchOfficesRepository branchOfficesRepository;
	private final IControlUserPermissionsRepository controlUserPermissionsRepository;
	private final IConfigParametersService configParametersService;
	private final ITypeUserRepository typeUserRepository;
	private final IUserBranchOfficesRepository userBranchOfficesRepository;
	private final IChannelRepository channelRepository;
	private final AuthenticationBsimService authenticationService;
	private final ReserveSerialBsimService reserveSeriesService;

	public BillingServiceImpl(IBillingRepository billingRepository, ILogsService logsService,
			IInvoiceDetailRepository invoiceDetailRepository, IBillingServicesRepository billingServicesRepository,
			IUserBranchOfficesService userBranchOfficesService, IUsersService usersService,
			IBranchOfficesService branchOfficesService, IBranchOfficesRepository branchOfficesRepository,
			IControlUserPermissionsRepository controlUserPermissionsRepository,
			IConfigParametersService configParametersService, ITypeUserRepository typeUserRepository,
			IUserBranchOfficesRepository userBranchOfficesRepository, IChannelRepository channelRepository,
			AuthenticationBsimService authenticationService, ReserveSerialBsimService reserveSeriesService) {
		super();
		this.billingRepository = billingRepository;
		this.logsService = logsService;
		this.invoiceDetailRepository = invoiceDetailRepository;
		this.billingServicesRepository = billingServicesRepository;
		this.userBranchOfficesService = userBranchOfficesService;
		this.usersService = usersService;
		this.branchOfficesService = branchOfficesService;
		this.branchOfficesRepository = branchOfficesRepository;
		this.controlUserPermissionsRepository = controlUserPermissionsRepository;
		this.configParametersService = configParametersService;
		this.typeUserRepository = typeUserRepository;
		this.userBranchOfficesRepository = userBranchOfficesRepository;
		this.channelRepository = channelRepository;
		this.authenticationService = authenticationService;
		this.reserveSeriesService = reserveSeriesService;

	}

	@Override
	public List<BillingModel> getAll() {
		List<BillingEntity> entities = this.billingRepository.getInvoicesOfTheDay();
		return entities.stream().map(BillingEntity::entityToModel).collect(Collectors.toList());
	}

	@Override
	public Page<BillingModel> getInvoicesAuthorizeIssue(Pageable pageable, String seller) {
		ControlUserPermissionsEntity controlUserPermissionsEntity = controlUserPermissionsRepository
				.findByUserName(seller);
		if (controlUserPermissionsEntity == null)
			throw new BadRequestException(String.format(Constants.ERROR_USER_NOT_EXISTS, seller));

		TypeUserEntity typeUserEntity = this.typeUserRepository.findById(controlUserPermissionsEntity.getTypeUser())
				.orElse(null);
		if (typeUserEntity == null)
			throw new BadRequestException(String.format(Constants.ERROR_USER_TYPE));

		UserBranchOfficesEntity userBranchOfficesEntity = this.userBranchOfficesRepository
				.findByIdUserActivated(controlUserPermissionsEntity.getIdUser());
		if (userBranchOfficesEntity == null)
			throw new BadRequestException(String.format(Constants.ERROR_USER_BRANCHOFFICE));

		List<ConfigParametersModel> listTypeUser = this.configParametersService.getByIdApplication(1002L);
		Map<String, List<String>> parametersTypeUser = new HashMap<>();
		Map<String, String> paramsTypeUser = new HashMap<>();

		for (ConfigParametersModel parameter : listTypeUser) {
			String paramName = parameter.getParameterName();
			String paramValue = parameter.getParameterValue();

			if (!parametersTypeUser.containsKey(paramName)) {
				parametersTypeUser.put(paramName, new ArrayList<>());
			}

			parametersTypeUser.get(paramName).add(paramValue);
			paramsTypeUser.put(paramName, paramValue);
		}

		List<String> userSeeAllInvoice = parametersTypeUser.get("USERS_SEE_ALL_INVOICES");
		List<String> userSeeOnlyTheirInvoices = parametersTypeUser.get("USERS_SEE_ONLY_THEIR_INVOICES");
		List<String> userSeeAllInvoiceBrachOffice = parametersTypeUser.get("USERS_SEE_ALL_INVOICES_BRACHOFFICE");

		Page<BillingEntity> billingEntities;

		if (userSeeAllInvoice != null && userSeeAllInvoice.contains(typeUserEntity.getTypeUser().toString())) {
			billingEntities = billingRepository.getInvoicesAuthorizeIssue(pageable);
		} else if (userSeeOnlyTheirInvoices != null
				&& userSeeOnlyTheirInvoices.contains(typeUserEntity.getTypeUser().toString())) {
			billingEntities = billingRepository.getInvoicesAuthorizeIssueBySellerBranchOffice(pageable, seller,
					userBranchOfficesEntity.getIdBranchOffices());
		} else if (userSeeAllInvoiceBrachOffice != null
				&& userSeeAllInvoiceBrachOffice.contains(typeUserEntity.getTypeUser().toString())) {
			billingEntities = billingRepository.getInvoicesAuthorizeIssueByBranchOffice(pageable,
					userBranchOfficesEntity.getIdBranchOffices());

		} else {
			throw new BadRequestException(String.format("User does not have permission to view invoices"));

		}

		return billingEntities.map(BillingEntity::entityToModel);
		// Page<BillingEntity> entities =
		// this.billingRepository.getInvoicesAuthorizeIssue(pageable);
		// return entities.map(BillingEntity::entityToModel);
	}

	@Override
	public Page<BillingModel> getInvoicesCancel(Pageable pageable, String seller) {

		ControlUserPermissionsEntity controlUserPermissionsEntity = controlUserPermissionsRepository
				.findByUserName(seller);
		if (controlUserPermissionsEntity == null)
			throw new BadRequestException(String.format(Constants.ERROR_USER_NOT_EXISTS, seller));

		TypeUserEntity typeUserEntity = this.typeUserRepository.findById(controlUserPermissionsEntity.getTypeUser())
				.orElse(null);
		if (typeUserEntity == null)
			throw new BadRequestException(String.format(Constants.ERROR_USER_TYPE));

		UserBranchOfficesEntity userBranchOfficesEntity = this.userBranchOfficesRepository
				.findByIdUserActivated(controlUserPermissionsEntity.getIdUser());
		if (userBranchOfficesEntity == null)
			throw new BadRequestException(String.format(Constants.ERROR_USER_BRANCHOFFICE));

		List<ConfigParametersModel> listTypeUser = this.configParametersService.getByIdApplication(1002L);
		Map<String, List<String>> parametersTypeUser = new HashMap<>();
		Map<String, String> paramsTypeUser = new HashMap<>();

		for (ConfigParametersModel parameter : listTypeUser) {
			String paramName = parameter.getParameterName();
			String paramValue = parameter.getParameterValue();

			if (!parametersTypeUser.containsKey(paramName)) {
				parametersTypeUser.put(paramName, new ArrayList<>());
			}

			parametersTypeUser.get(paramName).add(paramValue);
			paramsTypeUser.put(paramName, paramValue);
		}

		List<String> userSeeAllInvoice = parametersTypeUser.get("USERS_SEE_ALL_INVOICES");
		List<String> userSeeOnlyTheirInvoices = parametersTypeUser.get("USERS_SEE_ONLY_THEIR_INVOICES");
		List<String> userSeeAllInvoiceBrachOffice = parametersTypeUser.get("USERS_SEE_ALL_INVOICES_BRACHOFFICE");

		Page<BillingEntity> billingEntities;

		if (userSeeAllInvoice != null && userSeeAllInvoice.contains(typeUserEntity.getTypeUser().toString())) {
			billingEntities = billingRepository.getInvoicesCancel(pageable);
		} else if (userSeeOnlyTheirInvoices != null
				&& userSeeOnlyTheirInvoices.contains(typeUserEntity.getTypeUser().toString())) {
			billingEntities = billingRepository.getInvoicesCancelBySellerBranchOffice(pageable, seller,
					userBranchOfficesEntity.getIdBranchOffices());
		} else if (userSeeAllInvoiceBrachOffice != null
				&& userSeeAllInvoiceBrachOffice.contains(typeUserEntity.getTypeUser().toString())) {
			billingEntities = billingRepository.getInvoicesCancelByBranchOffice(pageable,
					userBranchOfficesEntity.getIdBranchOffices());

		} else {
			throw new BadRequestException(String.format("User does not have permission to view invoices"));

		}

		return billingEntities.map(BillingEntity::entityToModel);
	}

	@Override
	public List<BillingModel> findByFilter(int type, String value) {
		List<BillingEntity> entities;
		entities = this.billingRepository.findByFilter(type, value);
		return entities.stream().map(BillingEntity::entityToModel).collect(Collectors.toList());
	}

	@Override
	public List<BillingModel> getBillsByDateRange(Optional<LocalDate> startDate, Optional<LocalDate> endDate) {
		if (startDate == null || endDate == null) {
			throw new IllegalArgumentException(Constants.ERROR_INVALID_DATE);
		}
		LocalDate startDateTime = startDate.get();
		LocalDate endDateTime = endDate.get().plusDays(1);
		List<BillingEntity> entities = billingRepository.getBillsByDateRange(startDateTime, endDateTime);
		return entities.stream().map(BillingEntity::entityToModel).collect(Collectors.toList());
	}

	@Override
	public List<BillingModel> filterInvoices(List<Long> status, List<String> warehouses, List<String> agencies,
			Optional<LocalDate> startDate, Optional<LocalDate> endDate, String seller) {
		ControlUserPermissionsEntity controlUserPermissionsEntity = controlUserPermissionsRepository
				.findByUserName(seller);
		if (controlUserPermissionsEntity == null)
			throw new BadRequestException(String.format(Constants.ERROR_USER_NOT_EXISTS, seller));

		TypeUserEntity typeUserEntity = this.typeUserRepository.findById(controlUserPermissionsEntity.getTypeUser())
				.orElse(null);
		if (typeUserEntity == null)
			throw new BadRequestException(String.format(Constants.ERROR_USER_TYPE));

		UserBranchOfficesEntity userBranchOfficesEntity = this.userBranchOfficesRepository
				.findByIdUserActivated(controlUserPermissionsEntity.getIdUser());
		if (userBranchOfficesEntity == null)
			throw new BadRequestException(String.format(Constants.ERROR_USER_BRANCHOFFICE));

		List<ConfigParametersModel> listTypeUser = this.configParametersService.getByIdApplication(1003L);
		Map<String, List<String>> parametersTypeUser = new HashMap<>();
		Map<String, String> paramsTypeUser = new HashMap<>();

		for (ConfigParametersModel parameter : listTypeUser) {
			String paramName = parameter.getParameterName();
			String paramValue = parameter.getParameterValue();

			if (!parametersTypeUser.containsKey(paramName)) {
				parametersTypeUser.put(paramName, new ArrayList<>());
			}

			parametersTypeUser.get(paramName).add(paramValue);
			paramsTypeUser.put(paramName, paramValue);
		}

		List<String> userSeeAllReport = parametersTypeUser.get("SEE_ALL_REPORT");
		List<String> userSeeYourBranch = parametersTypeUser.get("SEE_ONLY_YOUR_BRANCH");

		Specification<BillingEntity> spec = InvoiceSpecifications.filterByParameters(status, warehouses, agencies,
				startDate, endDate, typeUserEntity, userBranchOfficesEntity, seller, userSeeAllReport,
				userSeeYourBranch);

		List<BillingEntity> filteredEntities = billingRepository.findAll(spec);

		return filteredEntities.stream().map(BillingEntity::entityToModel).collect(Collectors.toList());
	}

	@Override
	public BillingModel getBillsByIdAuthorizeIssue(Long id) {
		BillingEntity entity = this.billingRepository.getBillsByIdAuthorizeIssue(id);
		if (entity == null)
			throw new BadRequestException(String.format(Constants.ERROR_NOT_FOUND_RECORD, id));
		return entity.entityToModel();
	}

	@Override
	public BillingModel getBillsByIdInvoicesCancel(Long id) {
		BillingEntity entity = this.billingRepository.getBillsByIdInvoicesCancel(id);
		if (entity == null)
			throw new BadRequestException(String.format(Constants.ERROR_NOT_FOUND_RECORD, id));
		return entity.entityToModel();
	}

	@Override
	public BillingModel getById(Long id) {
		BillingEntity entity = this.billingRepository.findById(id).orElse(null);

		if (entity == null)
			throw new BadRequestException(String.format(Constants.ERROR_NOT_FOUND_RECORD, id));

		return entity.entityToModel();
	}

	/**
	 * Este método se utiliza para el VoucherService
	 * 
	 * @param id
	 * @return
	 */
	@Override
	public BillingModel findById(Long id) {
		BillingEntity entity = this.billingRepository.findById(id).orElse(null);
		if (entity == null) {
			return null;
		}
		return entity.entityToModel();
	}

	/**
	 * Método que se utiliza para el getVoucher
	 * 
	 */
	@Override
	public BillingModel findByIdReference(Long idReference) {
		List<BillingEntity> entities = this.billingRepository.findByIdReference(idReference);

		if (entities.isEmpty()) {
			return null;
		}

		return entities.get(0).entityToModel();

	}

	@Override
	public Long add(BillingModel model) {

		List<UsersEntity> user = this.usersService.findByUserName(model.getSeller());

		// Validamos si el usuario existe en la tabla de usuarios
		if (user.isEmpty()) {
			throw new BadRequestException(String.format(Constants.USER_NOT_FOUND, model.getSeller()));
		}

		// Validamos si existe o está asignado a una sucursal
		List<UserBranchOfficesEntity> userBranchOffices = this.userBranchOfficesService
				.findByIdUser(user.get(0).getId());

		if (userBranchOffices.isEmpty()) {
			throw new BadRequestException(String.format(Constants.USER_HAS_NOT_ASSIGNED, model.getSeller()));
		}

		UserBranchOfficesEntity userActive = null;

		for (UserBranchOfficesEntity validateUser : userBranchOffices) {

			if (validateUser.getStatus() == 1) {
				userActive = validateUser;
				break;
			}

		}

		/**
		 * Validamos si el usuario está activo en alguna sucursal
		 * 
		 */
		if (userActive == null) {
			throw new BadRequestException(String.format(Constants.USER_NOT_ACTIVE_BRANCHE_OFFICES, model.getSeller()));
		}

		BranchOfficesModel branchOffices = this.branchOfficesService.findById(userActive.getIdBranchOffices());

		ChannelEntity channelEntity = this.channelRepository.findById(model.getChannel()).orElse(null);

		if (model.getChannel() != null) {
			if (channelEntity == null) {
				throw new BadRequestException(
						String.format(Constants.ERROR_NOT_FOUND_RECORD_CHANNEL, model.getChannel()));

			} else if (channelEntity.getStatus() == 0) {
				throw new BadRequestException(String.format(Constants.VALIDATE_CHANNEL_STATUS, model.getChannel()));
			}
		}

		if (channelEntity.getReserveSerialNumber() == 1) {
			// Obtener el token de autenticación
			AuthenticationBsimResponse accessToken = authenticationService.getAccessToken();

			// Reservar los números de serie
			for (InvoiceDetailEntity detail : model.getInvoiceDetails()) {
				if (detail.getSerieOrBoxNumber() != null && !detail.getSerieOrBoxNumber().isEmpty()) {
					List<InvoiceDetailEntity> detailList = Arrays.asList(detail);
					reserveSeriesService.reserveSeries(accessToken.getAccess_token(), model.getInventoryType(),
							detail.getModel(),
							model.getWarehouse() != null && !model.getWarehouse().isEmpty() ? model.getWarehouse()
									: branchOffices.getWineryCode(),
							model.getSubWarehouse(), detailList);
				}
			}
		}

		BillingEntity entity = new BillingEntity();

		entity.setInvoiceNo(model.getInvoiceNo());
		entity.setInvoiceType(model.getInvoiceType());
		entity.setIdReference(model.getIdReference());
		entity.setAcctCode(model.getAcctCode());
		entity.setPrimaryIdentity(model.getPrimaryIdentity());
		entity.setDocumentNo(model.getDocumentNo());
		entity.setDiplomaticCardNo(model.getDiplomaticCardNo());
		entity.setCorrelativeOrdenExemptNo(model.getCorrelativeOrdenExemptNo());
		entity.setCorrelativeCertificateExoNo(model.getCorrelativeCertificateExoNo());
		entity.setXml(model.getXml());
		entity.setCai(model.getCai());
		entity.setCustomer(model.getCustomer());
		entity.setCustomerId(model.getCustomerId());
		entity.setCashierName(model.getCashierName());
		entity.setSeller(model.getSeller());
		entity.setSellerCode(model.getSellerCode());
		entity.setIdBranchOffices(
				model.getIdBranchOffices() != null ? model.getIdBranchOffices() : branchOffices.getId());
		entity.setAgency(model.getAgency() != null ? model.getAgency() : branchOffices.getName());
		entity.setWarehouse(model.getWarehouse() != null && !model.getWarehouse().isEmpty() ? model.getWarehouse()
				: branchOffices.getWineryCode());
		entity.setDueDate(LocalDateTime.now().plusMonths(1));
		entity.setInitialRank(model.getInitialRank());
		entity.setFinalRank(model.getFinalRank());
		entity.setIdCompany(model.getIdCompany());
		entity.setIdSystem(model.getIdSystem());
		entity.setNumberDei(model.getNumberDei());
		entity.setDeadLine(model.getDeadLine());
		entity.setIdVoucher(model.getIdVoucher());
		entity.setSubtotal(model.getSubtotal());
		entity.setExchangeRate(model.getExchangeRate());
		entity.setDiscount(model.getDiscount());
		entity.setDiscountPercentage(model.getDiscountPercentage());
		entity.setTaxPercentage(model.getTaxPercentage());
		entity.setAmountTax(model.getAmountTax());
		entity.setAmountExo(model.getAmountExo());
		entity.setAmountTotal(model.getAmountTotal());
		entity.setAuthorizingUser(model.getAuthorizingUser());
		entity.setAuthorizationDate(model.getAuthorizationDate());
		entity.setUserIssued(model.getUserIssued());
		entity.setDateOfIssue(model.getDateOfIssue());
		entity.setExonerationStatus(0L);
		entity.setStatus(0L);
		entity.setCreated(LocalDateTime.now());
		entity.setInventoryType(model.getInventoryType());
		entity.setSubWarehouse(model.getSubWarehouse());
		entity.setChannel(model.getChannel());
		entity.setExemptAmount(model.getExemptAmount());
		entity.setCustomerAddress(model.getCustomerAddress());
		entity.setCustomerRtnId(model.getCustomerRtnId());
		entity.setSellerName(user.get(0).getName());
		entity = this.billingRepository.save(entity);
		Long generatedId = entity.getId();

		List<InvoiceDetailEntity> invoiceDetails = new ArrayList<>();
		for (@Valid
		InvoiceDetailEntity detailModel : model.getInvoiceDetails()) {
			InvoiceDetailEntity detailEntity = new InvoiceDetailEntity();

			String detailDescription;
			if (StringUtils.isBlank(detailModel.getDescription())) {
				BillingServicesEntity billingServicesEntity = this.billingServicesRepository
						.findByServiceCode(Long.parseLong(detailModel.getModel()));
				detailDescription = billingServicesEntity.getServiceName();
			} else {
				detailDescription = detailModel.getDescription();
			}

			detailEntity.setBilling(entity);
			detailEntity.setModel(detailModel.getModel().trim());
			detailEntity.setDescription(detailDescription);
			detailEntity.setQuantity(detailModel.getQuantity());
			detailEntity.setUnitPrice(detailModel.getUnitPrice());
			detailEntity.setAmountTotal(detailModel.getAmountTotal());
			detailEntity.setSerieOrBoxNumber(detailModel.getSerieOrBoxNumber());
			detailEntity.setStatus(1L);
			detailEntity.setCreated(LocalDateTime.now());
			invoiceDetails.add(detailEntity);
		}
		this.invoiceDetailRepository.saveAll(invoiceDetails);

		return generatedId;

	}

	@Override
	public void updateDataForAddVoucher(Long id, BillingModel model) {
		BillingEntity entity = this.billingRepository.findById(id).orElse(null);
		entity.setIdReference(model.getIdReference());
		entity.setCai(model.getCai());
		entity.setIdCompany(model.getIdCompany());
		entity.setIdSystem(model.getIdSystem());
		entity.setIdVoucher(model.getIdVoucher());
		entity.setNumberDei(model.getNumberDei());
		entity.setDeadLine(model.getDeadLine());
		entity.setCustomerId(model.getCustomerId());
		entity.setIdBranchOffices(model.getIdBranchOffices());
		entity.setAgency(model.getAgency());
		entity.setStatus(model.getStatus());

		this.billingRepository.save(entity);
	}

	@Override
	public void update(Long id, BillingModel model) {

		BillingEntity entity = this.billingRepository.findById(id).orElse(null);
		if (entity == null)
			throw new BadRequestException(String.format(Constants.ERROR_NOT_FINDING_AN_ID_IN_UPDATE, id));

		// Verificar si el usuario vendedor existe en la tabla de usuarios
		List<UsersEntity> user = this.usersService.findByUserName(model.getSeller());
		if (user.isEmpty()) {
			throw new BadRequestException(String.format(Constants.USER_NOT_FOUND, model.getSeller()));
		}

		// Verificar si el usuario vendedor está asignado a una sucursal
		List<UserBranchOfficesEntity> userBranchOffices = this.userBranchOfficesService
				.findByIdUser(user.get(0).getId());
		if (userBranchOffices.isEmpty()) {
			throw new BadRequestException(String.format(Constants.USER_HAS_NOT_ASSIGNED, model.getSeller()));
		}

		// Verificar si el usuario vendedor está activo en alguna sucursal
		UserBranchOfficesEntity userActive = null;
		for (UserBranchOfficesEntity validateUser : userBranchOffices) {
			if (validateUser.getStatus() == 1) {
				userActive = validateUser;
				break;
			}
		}
		if (userActive == null) {
			throw new BadRequestException(String.format(Constants.USER_NOT_ACTIVE_BRANCHE_OFFICES, model.getSeller()));
		}

		BranchOfficesModel branchOffices = this.branchOfficesService.findById(userActive.getIdBranchOffices());

		// Actualizar los campos de la entidad BillingEntity
		entity.setInvoiceNo(model.getInvoiceNo());
		entity.setInvoiceType(model.getInvoiceType());
		entity.setIdReference(model.getIdReference());
		entity.setAcctCode(model.getAcctCode());
		entity.setPrimaryIdentity(model.getPrimaryIdentity());
		entity.setDocumentNo(model.getDocumentNo());
		entity.setDiplomaticCardNo(model.getDiplomaticCardNo());
		entity.setCorrelativeOrdenExemptNo(model.getCorrelativeOrdenExemptNo());
		entity.setCorrelativeCertificateExoNo(model.getCorrelativeCertificateExoNo());
		entity.setXml(model.getXml());
		entity.setCai(model.getCai());
		entity.setCustomer(model.getCustomer());
		entity.setCustomerId(model.getCustomerId());
		entity.setCashierName(model.getCashierName());
		entity.setSeller(model.getSeller());
		entity.setSellerCode(model.getSellerCode());
		entity.setIdBranchOffices(branchOffices.getId());
		entity.setAgency(branchOffices.getName());
		entity.setWarehouse(model.getWarehouse() != null && !model.getWarehouse().isEmpty() ? model.getWarehouse()
				: branchOffices.getWineryCode());
		entity.setDueDate(LocalDateTime.now().plusMonths(1));
		entity.setInitialRank(model.getInitialRank());
		entity.setFinalRank(model.getFinalRank());
		entity.setIdCompany(model.getIdCompany());
		entity.setIdSystem(model.getIdSystem());
		entity.setNumberDei(model.getNumberDei());
		entity.setDeadLine(model.getDeadLine());
		entity.setIdVoucher(model.getIdVoucher());
		entity.setSubtotal(model.getSubtotal());
		entity.setExchangeRate(model.getExchangeRate());
		entity.setDiscount(model.getDiscount());
		entity.setDiscountPercentage(model.getDiscountPercentage());
		entity.setTaxPercentage(model.getTaxPercentage());
		entity.setAmountTax(model.getAmountTax());
		entity.setAmountExo(model.getAmountExo());
		entity.setAmountTotal(model.getAmountTotal());
		entity.setAuthorizingUser(model.getAuthorizingUser());
		entity.setAuthorizationDate(model.getAuthorizationDate());
		entity.setUserIssued(model.getUserIssued());
		entity.setDateOfIssue(model.getDateOfIssue());
		entity.setExonerationStatus(0L);
		entity.setStatus(model.getStatus());
		entity.setCreated(LocalDateTime.now());
		entity.setInventoryType(model.getInventoryType());
		entity.setSubWarehouse(model.getSubWarehouse());
		entity.setChannel(model.getChannel());
		entity.setExemptAmount(model.getExemptAmount());
		entity.setCustomerAddress(model.getCustomerAddress());
		entity.setCustomerRtnId(model.getCustomerRtnId());
		entity.setSellerName(user.get(0).getName());
		entity.setTotalLps(model.getTotalLps());
		entity.setTotalLpsLetters(model.getTotalLpsLetters());
		this.billingRepository.save(entity);

		/*
		 * // Actualizar o crear los detalles de la factura List<InvoiceDetailEntity>
		 * invoiceDetails = new ArrayList<>(); for (InvoiceDetailEntity detailModel :
		 * model.getInvoiceDetails()) { InvoiceDetailEntity detailEntity =
		 * this.invoiceDetailRepository .findByBillingIdAndModel(entity.getId(),
		 * detailModel.getModel()).orElse(new InvoiceDetailEntity());
		 * 
		 * String detailDescription; if
		 * (StringUtils.isBlank(detailModel.getDescription())) { BillingServicesEntity
		 * billingServicesEntity = this.billingServicesRepository
		 * .findByServiceCode(Long.parseLong(detailModel.getModel())); detailDescription
		 * = billingServicesEntity.getServiceName(); } else { detailDescription =
		 * detailModel.getDescription(); }
		 * 
		 * detailEntity.setBilling(entity);
		 * detailEntity.setModel(detailModel.getModel());
		 * detailEntity.setDescription(detailDescription);
		 * detailEntity.setQuantity(detailModel.getQuantity());
		 * detailEntity.setUnitPrice(detailModel.getUnitPrice());
		 * detailEntity.setAmountTotal(detailModel.getAmountTotal());
		 * detailEntity.setSerieOrBoxNumber(detailModel.getSerieOrBoxNumber());
		 * detailEntity.setStatus(1L); detailEntity.setCreated(LocalDateTime.now());
		 * invoiceDetails.add(detailEntity); }
		 * this.invoiceDetailRepository.saveAll(invoiceDetails);
		 */
	}

	@Override
	public void updateStatusInvoice(Long id, Long status, String authorizingUser, LocalDateTime authorizationDate,
			String userIssued, LocalDateTime dateOfIssue) {
		long startTime = System.currentTimeMillis();

		try {
			BillingEntity entity = this.billingRepository.findById(id).orElse(null);
			if (entity == null) {
				throw new BadRequestException(String.format(Constants.ERROR_NOT_FINDING_AN_ID_IN_UPDATE, id));
			}
			entity.setAuthorizingUser(authorizingUser);
			entity.setAuthorizationDate(authorizationDate);
			entity.setUserIssued(userIssued);
			entity.setDateOfIssue(dateOfIssue);
			entity.setStatus(status);

			this.billingRepository.save(entity);

		} catch (BadRequestException e) {
			long duration = System.currentTimeMillis() - startTime;

			logsService.saveLog(2, id, "Error occurred while updating status invoice: " + e.getMessage(),
					authorizingUser, duration);
			throw e;
		} catch (Exception e) {
			long duration = System.currentTimeMillis() - startTime;

			logsService.saveLog(2, id, "Error occurred while updating status invoice: " + e.getMessage(),
					authorizingUser, duration);
			throw e;
		}
	}

	@Override
	public void updateDocumentNo(Long id, String documentNo) {
		long startTime = System.currentTimeMillis();

		try {
			BillingEntity entity = this.billingRepository.findById(id).orElse(null);
			if (entity == null) {
				throw new BadRequestException(String.format(Constants.ERROR_UPDATE_FIELDS, id));
			}
			entity.setDocumentNo(documentNo);

			this.billingRepository.save(entity);
		} catch (BadRequestException e) {
			long duration = System.currentTimeMillis() - startTime;

			logsService.saveLog(3, id, "Error occurred while updating document number: " + e.getMessage(), null,
					duration);

			throw e;
		} catch (Exception e) {
			long duration = System.currentTimeMillis() - startTime;

			logsService.saveLog(3, id, "Error occurred while updating document number: " + e.getMessage(), null,
					duration);
			throw e;
		}
	}

	@Override
	public void updateCorporateClient(Long id, BillingModel model) {
		long startTime = System.currentTimeMillis();

		try {
			BillingEntity entity = this.billingRepository.findById(id).orElse(null);
			if (entity == null) {
				throw new BadRequestException(String.format(Constants.ERROR_UPDATE_FIELDS, id));
			}

			if (entity.getStatus() != 0) {
				throw new BadRequestException(
						String.format("La factura no se puede exonerar, ya que no es una factura pendiente", id));
			}

			entity.setCorrelativeOrdenExemptNo(model.getCorrelativeOrdenExemptNo());
			entity.setCorrelativeCertificateExoNo(model.getCorrelativeCertificateExoNo());
			entity.setExonerationStatus(1L);
			entity.setAmountTotal(entity.getAmountTotal() - entity.getAmountTax());
			entity.setAmountExo(entity.getAmountTax());
			entity.setAmountTax(0.0);

			this.billingRepository.save(entity);
		} catch (BadRequestException e) {
			long duration = System.currentTimeMillis() - startTime;

			logsService.saveLog(4, id, "Error occurred while updating Corporate Client: " + e.getMessage(),
					model.getUserIssued(), duration);
			throw e;
		} catch (Exception e) {
			long duration = System.currentTimeMillis() - startTime;

			logsService.saveLog(4, id, "Error occurred while updating Corporate Client: " + e.getMessage(),
					model.getUserIssued(), duration);
			throw e;
		}
	}

	@Override
	public void updateSingleClient(Long id, BillingModel model) {
		long startTime = System.currentTimeMillis();

		try {
			BillingEntity entity = this.billingRepository.findById(id).orElse(null);
			if (entity == null) {
				throw new BadRequestException(String.format(Constants.ERROR_UPDATE_FIELDS, id));
			}

			if (entity.getStatus() != 0) {
				throw new BadRequestException(
						String.format("La factura no se puede exonerar, ya que no es una factura pendiente", id));
			}

			entity.setDiplomaticCardNo(model.getDiplomaticCardNo());
			entity.setExonerationStatus(1L);
			entity.setAmountTotal(entity.getAmountTotal() - entity.getAmountTax());
			entity.setAmountExo(entity.getAmountTax());
			entity.setAmountTax(0.0);

			this.billingRepository.save(entity);
		} catch (

		BadRequestException e) {
			long duration = System.currentTimeMillis() - startTime;

			logsService.saveLog(5, id, "Error occurred while updating Single Client: " + e.getMessage(),
					model.getUserIssued(), duration);
			throw e;
		} catch (Exception e) {
			long duration = System.currentTimeMillis() - startTime;

			logsService.saveLog(5, id, "Error occurred while updating Single Client: " + e.getMessage(),
					model.getUserIssued(), duration);
			throw e;
		}
	}

	@Override
	public void updateStatusExoTax(Long id) {
		long startTime = System.currentTimeMillis();

		try {
			BillingEntity entity = this.billingRepository.findById(id).orElse(null);
			if (entity == null) {
				throw new BadRequestException(String.format(Constants.ERROR_UPDATE_FIELDS, id));
			}

			Long currentStatus = entity.getStatus();

			if (currentStatus == 3L) {
				entity.setStatus(5L);
			} else if (currentStatus == 4L) {
				entity.setStatus(5L);
			} else if (currentStatus == 5L) {
				entity.setStatus(10L);
			} else {
				throw new BadRequestException(String.format("Invalid status %s for update", currentStatus));
			}

			entity.setTaxPercentage(0.0);

			this.billingRepository.save(entity);
		} catch (

		BadRequestException e) {
			long duration = System.currentTimeMillis() - startTime;

			logsService.saveLog(6, id, "Error occurred while updating status invoice exonerated: " + e.getMessage(),
					null, duration);
			throw e;
		} catch (Exception e) {
			long duration = System.currentTimeMillis() - startTime;

			logsService.saveLog(6, id, "Error occurred while updating status invoice exonerated: " + e.getMessage(),
					null, duration);
			throw e;
		}
	}

	@Override
	public InvoiceDetailGraphicsResponse getInvoiceDetailsGraphByDateRangeAndFilters(Optional<LocalDate> startDate,
			Optional<LocalDate> endDate, List<String> agencies, List<String> invoiceType, List<Long> status) {

		Specification<BillingEntity> specInvoice = InvoiceGraphFiltersSpecifications.filterByGraph(startDate, endDate,
				agencies, invoiceType, status);

		List<BillingEntity> billingEntities = billingRepository.findAll(specInvoice);

		Long unauthorizedInvoices = billingEntities.stream().filter(entity -> entity.getStatus() == 0).count();
		Long authorizedInvoices = billingEntities.stream().filter(entity -> entity.getStatus() == 1).count();
		Long issuedInvoices = billingEntities.stream().filter(entity -> entity.getStatus() == 2).count();
		Long invoicesWithTaxNumber = billingEntities.stream().filter(entity -> entity.getStatus() == 4).count();
		Long canceledInvoicesWithoutIssued = billingEntities.stream().filter(entity -> entity.getStatus() == 5).count();
		Long canceledInvoicesWithTaxNumber = billingEntities.stream().filter(entity -> entity.getStatus() == 6).count();
		Long errorInvoice = billingEntities.stream().filter(entity -> entity.getStatus() == -1).count();

		Map<String, Long> invoiceTypeCounts = billingEntities.stream()
				.collect(Collectors.groupingBy(BillingEntity::getInvoiceType, Collectors.counting()));

		Map<String, Long> sellerCounts = billingEntities.stream()
				.collect(Collectors.groupingBy(BillingEntity::getSeller, Collectors.counting()));

		InvoiceDetailGraphicsResponse response = new InvoiceDetailGraphicsResponse();
		response.setUnauthorizedInvoices(unauthorizedInvoices);
		response.setAuthorizedInvoices(authorizedInvoices);
		response.setIssuedInvoices(issuedInvoices);
		response.setInvoicesWithTaxNumber(invoicesWithTaxNumber);
		response.setCanceledInvoicesWithoutIssued(canceledInvoicesWithoutIssued);
		response.setCanceledInvoicesWithTaxNumber(canceledInvoicesWithTaxNumber);
		response.setErrorInvoice(errorInvoice);
		response.setInvoicesByType(invoiceTypeCounts);
		response.setInvoicesPerSeller(sellerCounts);

		return response;
	}

	private static final Map<Long, String> statusNames = new HashMap<>();

	static {
		statusNames.put(-1L, "errorInvoice");
		statusNames.put(0L, "unauthorizedInvoices");
		statusNames.put(1L, "authorizedInvoices");
		statusNames.put(2L, "issuedInvoices");
		statusNames.put(4L, "invoicesWithTaxNumber");
		statusNames.put(5L, "canceledInvoicesWithoutIssued");
		statusNames.put(6L, "canceledInvoicesWithTaxNumber");
	}

	@Override
	public List<InvoiceTypeAndStatus> getInvoiceDetailsByTypeAndStatusAndFilters(Optional<LocalDate> startDate,
			Optional<LocalDate> endDate, List<String> agencies, List<String> invoiceType, List<Long> status) {

		Specification<BillingEntity> spec = InvoiceGraphFiltersSpecifications.filterByGraph(startDate, endDate,
				agencies, invoiceType, status);

		List<BillingEntity> results = billingRepository.findAll(spec);

		Map<String, Map<String, Long>> groupedResults = results.stream()
				.collect(Collectors.groupingBy(BillingEntity::getInvoiceType, Collectors
						.groupingBy(result -> statusNames.get(result.getStatus().longValue()), Collectors.counting())));

		return groupedResults.entrySet().stream().flatMap(entry -> entry.getValue().entrySet().stream().map(
				statusEntry -> new InvoiceTypeAndStatus(entry.getKey(), statusEntry.getKey(), statusEntry.getValue())))
				.collect(Collectors.toList());
	}

	@Override
	public List<BranchOfficeAndStatus> getInvoiceDetailsByBranchOfficeAndStatus(Optional<LocalDate> startDate,
			Optional<LocalDate> endDate, List<String> agencies, List<String> invoiceType, List<Long> status) {

		Specification<BillingEntity> spec = InvoiceGraphFiltersSpecifications.filterByGraph(startDate, endDate,
				agencies, invoiceType, status);

		List<BillingEntity> results = billingRepository.findAll(spec);

		// Obtener los nombres de las agencias a partir de los resultados
		Map<String, List<BillingEntity>> groupedByAgency = results.stream()
				.collect(Collectors.groupingBy(BillingEntity::getAgency));

		// Agrupar los resultados por nombre de agencia y estado
		Map<String, Map<String, Long>> groupedResults = groupedByAgency.entrySet().stream()
				.collect(Collectors.toMap(Map.Entry::getKey, entry -> entry.getValue().stream().collect(
						Collectors.groupingBy(result -> statusNames.get(result.getStatus()), Collectors.counting()))));

		// Convertir el Map en una lista de BranchOfficeAndStatus
		return groupedResults.entrySet().stream().flatMap(entry -> entry.getValue().entrySet().stream().map(
				statusEntry -> new BranchOfficeAndStatus(entry.getKey(), statusEntry.getKey(), statusEntry.getValue())))
				.collect(Collectors.toList());
	}

	@Override
	public void delete(Long id) {
		BillingEntity entity = this.billingRepository.findById(id).orElse(null);
		if (entity == null)
			throw new BadRequestException(String.format(Constants.ERROR_NOT_FINDING_AN_ID_IN_DELETE, id));

		this.billingRepository.delete(entity);
	}

	@Override
	public String getInvoiceDetailBase64ById(Long id) {
		BillingEntity billingEntity = this.billingRepository.findById(id).orElse(null);
		if (billingEntity == null)
			throw new BadRequestException(String.format(Constants.ERROR_NOT_FOUND_RECORD, id));

		BranchOfficesEntity branchOfficesEntity = this.branchOfficesRepository
				.findById(billingEntity.getIdBranchOffices()).orElse(null);
		if (branchOfficesEntity == null)
			throw new BadRequestException(String.format(Constants.ERROR_NOT_FINDING_AN_ID, id));

		return InvoicePrintingDetailGenerator.generateInvoiceDetail(billingEntity, branchOfficesEntity);
	}

	@Override
	public BillingModel getInvoiceBySerialNumber(String serie) {
		InvoiceDetailEntity invoiceDetailentity = this.invoiceDetailRepository.getDetailBySerie(serie);
		if (invoiceDetailentity == null)
			throw new BadRequestException(String.format(Constants.ERROR_NOT_FOUND_RECORD_SERIE, serie));

		BillingEntity billingEntity = this.billingRepository.findById(invoiceDetailentity.getBilling().getId())
				.orElse(null);

		if (billingEntity.getStatus() != 2)
			throw new BadRequestException(String.format(Constants.INVOICE_NOT_ISSUED));

		return billingEntity.entityToModel();
	}

}
