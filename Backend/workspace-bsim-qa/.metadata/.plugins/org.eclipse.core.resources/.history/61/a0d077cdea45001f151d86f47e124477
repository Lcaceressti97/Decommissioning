package hn.com.tigo.equipmentaccessoriesbilling.provider;

import javax.ws.rs.BadRequestException;

import org.springframework.stereotype.Service;

import com.google.gson.Gson;

import hn.com.tigo.equipmentaccessoriesbilling.mapper.MapperCBSQueryCustomerInfo;
import hn.com.tigo.equipmentaccessoriesbilling.models.CustomerInfoModel;
import hn.com.tigo.equipmentaccessoriesbilling.models.AcctAccessCode;
import hn.com.tigo.equipmentaccessoriesbilling.models.QueryObj;
import hn.com.tigo.equipmentaccessoriesbilling.models.RequestBase;
import hn.com.tigo.equipmentaccessoriesbilling.services.customerinfo.AdapterException_Exception;
import hn.com.tigo.equipmentaccessoriesbilling.services.customerinfo.CBSQueryCustomerInfoTask;
import hn.com.tigo.equipmentaccessoriesbilling.services.customerinfo.CBSQueryCustomerInfoTaskService;
import hn.com.tigo.equipmentaccessoriesbilling.services.customerinfo.ParameterArray;
import hn.com.tigo.equipmentaccessoriesbilling.services.customerinfo.ParameterType;
import hn.com.tigo.equipmentaccessoriesbilling.services.customerinfo.TaskRequestType;
import hn.com.tigo.equipmentaccessoriesbilling.services.customerinfo.TaskResponseType;

@Service
public class CustomerInfoProvider {

	// Props

	public CustomerInfoProvider() {

	}

	public CustomerInfoModel getCustomerInfoByAcctCode(final String acctCode) {

		CustomerInfoModel customerInfo = new CustomerInfoModel();

		CBSQueryCustomerInfoTaskService cBSQueryCustomerInfoTaskService = new CBSQueryCustomerInfoTaskService();

		CBSQueryCustomerInfoTask cBSQueryCustomerInfoTask = cBSQueryCustomerInfoTaskService
				.getCBSQueryCustomerInfoTaskPort();

		try {

			TaskResponseType taskResponseType = cBSQueryCustomerInfoTask
					.executeTask(this.buildTaskRequestTypeByAccountCode(acctCode));

			Gson gson = new Gson();
			MapperCBSQueryCustomerInfo mapper = null;

			for (ParameterType row : taskResponseType.getParameters().getParameter()) {
				mapper = gson.fromJson(row.getValue(), MapperCBSQueryCustomerInfo.class);

				break;
			}

			retorno.setBillingAccount(mapper.getQueryCustomerInfoResultMsg().getQueryCustomerInfoResult().getAccount()
					.getAcctKey().toString());
			retorno.setCustomerAccount(mapper.getQueryCustomerInfoResultMsg().getQueryCustomerInfoResult().getAccount()
					.getAcctInfo().getUserCustomer().getCustKey());
			
			System.out.println("QueryCustomerInfoResult: " + mapper.getQueryCustomerInfoResultMsg().getQueryCustomerInfoResult().getAccount());

		} catch (AdapterException_Exception e) {
			throw new BadRequestException(e.getMessage());
		}

		return retorno;
	}

	// Methods

	/**
	 * Se construye el request del Servicio Soap CBSQueryCustomerInfoTaskService por
	 * el AccountCode
	 * 
	 * @return
	 */
	private TaskRequestType buildTaskRequestTypeByAccountCode(final String accountCode) {

		// Instanciamos la clase de retorno
		TaskRequestType taskRequestType = new TaskRequestType();

		// Instanciamos las clases que representan el json
		ParameterType parameterType = new ParameterType();
		ParameterArray parameterArray = new ParameterArray();

		QueryObj queryObj = new QueryObj();

		// Seteamos los valores
		AcctAccessCode acctAccessCode = new AcctAccessCode();
		acctAccessCode.setAccountCode(accountCode);
		acctAccessCode.setPayType("2");

		queryObj.setAcctAccessCode(acctAccessCode);

		// Seteamos el request
		RequestBase requestBase = new RequestBase();

		requestBase.setQueryObj(queryObj);

		// Crear un objeto Gson
		Gson gson = new Gson();

		// Convertir la instancia de la clase QueryObj a una cadena con formato JSON
		String json = gson.toJson(requestBase);
		System.out.println(json);

		parameterType.setName("JSON");
		parameterType.setValue(json);

		parameterArray.getParameter().add(parameterType);

		taskRequestType.setParameters(parameterArray);

		return taskRequestType;
	}
}
